<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { padding: 20px; background-color: #f8f9fa; }</style>
</head>
<body>

<div class="card shadow-sm">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 fw-bold text-primary"><i class="fas fa-tags"></i> 商品分类列表</h5>
        <button class="btn btn-primary" id="btnOpenAdd"><i class="fas fa-plus"></i> 新增分类</button>
    </div>
    <div class="card-body">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>分类名称</th>
                    <th style="width: 200px;">操作</th>
                </tr>
            </thead>
            <tbody id="tbody">
                </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="typeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">新增分类</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="typeForm">
                    <input type="hidden" id="typeId">
                    <div class="mb-3">
                        <label class="form-label">分类名称</label>
                        <input type="text" class="form-control" id="typeName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnSave">保存提交</button>
            </div>
        </div>
    </div>
</div>

<script src="../public/js/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../public/js/config.js"></script>

<script>
    let myModal; // 保存 Modal 实例

    $(function() {
        // 1. 初始化 Modal
        myModal = new bootstrap.Modal(document.getElementById('typeModal'));

        // 2. 加载列表
        loadList();

        // 3. 绑定“新增”按钮点击事件 (解决点不了的问题)
        $('#btnOpenAdd').click(function() {
            $('#typeForm')[0].reset(); // 重置表单
            $('#typeId').val('');      // 清空ID
            $('#modalTitle').text('新增分类');
            myModal.show();
        });

        // 4. 绑定“保存”按钮
        $('#btnSave').click(submitData);
    });

    // 加载数据
    function loadList() {
        $.get(API_BASE_URL + "/find_type", function(res) {
            if (res.code === 200) {
                let html = '';
                res.data.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.id}</td>
                            <td><span class="badge bg-info text-dark fs-6">${item.name}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="toEdit(${item.id}, '${item.name}')">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="doDel(${item.id})">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </td>
                        </tr>
                    `;
                });
                $('#tbody').html(html);
            }
        });
    }

    // 提交数据 (新增或修改)
    function submitData() {
        const id = $('#typeId').val();
        const name = $('#typeName').val();

        if (!name) {
            Swal.fire('提示', '分类名称不能为空', 'warning');
            return;
        }

        const url = id ? API_BASE_URL + "/update_type" : API_BASE_URL + "/create_type";
        const data = id ? { id, name } : { name };

        $.post(url, data, function(res) {
            if (res.code === 200) {
                myModal.hide();
                Swal.fire('成功', '操作成功', 'success');
                loadList();
            } else {
                Swal.fire('失败', res.msg, 'error');
            }
        });
    }

    // 编辑准备
    window.toEdit = function(id, name) {
        $('#typeId').val(id);
        $('#typeName').val(name);
        $('#modalTitle').text('编辑分类');
        myModal.show();
    }

    // 删除操作
    window.doDel = function(id) {
        Swal.fire({
            title: '确定删除吗?',
            text: "删除后无法恢复!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: '是的, 删除!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.post(API_BASE_URL + "/remove_type", { id }, function(res) {
                    if (res.code === 200) {
                        Swal.fire('已删除!', '该分类已被移除.', 'success');
                        loadList();
                    } else {
                        Swal.fire('失败', res.msg, 'error');
                    }
                });
            }
        })
    }
</script>
</body>
</html>